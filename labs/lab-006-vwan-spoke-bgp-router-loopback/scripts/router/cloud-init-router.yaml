#cloud-config
# labs/lab-006-vwan-spoke-bgp-router-loopback/scripts/router/cloud-init-router.yaml
# Bootstrap for FRR router VM -- installs FRR, enables IP forwarding, creates loopback
#
# deploy.ps1 Phase 4 overwrites /etc/frr/frr.conf with the REAL vHub peer IPs.
# The IPs below (10.0.0.69, 10.0.0.70) are common defaults but NOT guaranteed.

package_update: true
package_upgrade: false

packages:
  - frr
  - frr-pythontools
  - tcpdump
  - traceroute
  - net-tools
  - jq
  - curl

write_files:
  # NOTE: /etc/frr/daemons is NOT written here because the FRR package
  # install (from packages: above) overwrites it with bgpd=no.
  # Instead, we fix it in runcmd after package install completes.

  # FRR configuration -- BGP peering to vHub (active-active)
  # deploy.ps1 Phase 4 overwrites this with actual IPs from az network vhub show.
  - path: /etc/frr/frr.conf
    content: |
      frr version 8.1
      frr defaults traditional
      hostname router-006
      log syslog informational
      no ipv6 forwarding
      !
      router bgp 65100
       bgp router-id 10.61.1.4
       no bgp ebgp-requires-policy
       !
       ! vHub active-active BGP peers (deploy.ps1 Phase 4 overwrites with actual IPs)
       neighbor 10.0.0.69 remote-as 65515
       neighbor 10.0.0.70 remote-as 65515
       !
       address-family ipv4 unicast
        network 10.61.250.1/32
        network 10.200.200.1/32
       exit-address-family
      !
      line vty
      !
    owner: frr:frr
    permissions: '0640'

  # IP forwarding sysctl
  - path: /etc/sysctl.d/99-ip-forward.conf
    content: |
      net.ipv4.ip_forward=1
    permissions: '0644'

  # Health check script (invoked by deploy.ps1 via az vm run-command)
  - path: /usr/local/bin/lab006_check.sh
    content: |
      #!/bin/bash
      echo "=== FRR daemon ==="
      systemctl is-active frr 2>/dev/null || echo "frr not running"
      echo "=== bgpd enabled ==="
      grep '^bgpd=' /etc/frr/daemons 2>/dev/null || echo "daemons file missing"
      echo "=== TCP 179 ==="
      ss -tlnp sport = :179 2>/dev/null || echo "ss failed"
      echo "=== BGP Summary ==="
      vtysh -c 'show bgp summary' 2>/dev/null || echo "vtysh unavailable"
      echo "=== Loopback ==="
      ip addr show lo0 2>/dev/null || echo "lo0 not found"
      echo "=== IP Forward ==="
      sysctl net.ipv4.ip_forward 2>/dev/null
    permissions: '0755'

runcmd:
  # Enable IP forwarding immediately
  - sysctl -w net.ipv4.ip_forward=1

  # Create dummy loopback interface
  - ip link add lo0 type dummy
  - ip link set lo0 up
  - ip addr add 10.61.250.1/32 dev lo0
  - ip addr add 10.200.200.1/32 dev lo0

  # Make loopback persistent across reboots
  - |
    cat > /etc/networkd-dispatcher/routable.d/50-loopback <<'SCRIPT'
    #!/bin/bash
    ip link show lo0 > /dev/null 2>&1 || {
      ip link add lo0 type dummy
      ip link set lo0 up
      ip addr add 10.61.250.1/32 dev lo0
      ip addr add 10.200.200.1/32 dev lo0
    }
    SCRIPT
  - chmod +x /etc/networkd-dispatcher/routable.d/50-loopback

  # Fix FRR daemons AFTER package install (the package overwrites with bgpd=no)
  - sed -i 's/^bgpd=no/bgpd=yes/' /etc/frr/daemons
  - chown frr:frr /etc/frr/daemons
  - chmod 640 /etc/frr/daemons

  # Restart FRR to pick up config
  - systemctl enable frr
  - systemctl restart frr

  # Log completion
  - echo "cloud-init router bootstrap complete" | systemd-cat -t cloud-init-lab006
